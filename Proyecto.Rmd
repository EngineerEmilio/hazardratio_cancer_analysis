---
Protitle: "TimeSeries Hazard Rate"
author: "Emilio Morales Luna"
date: "2023-11-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introducción:

De acuerdo con la Organización Mundial de la Salud, el cáncer es la segunda causa de muerte a nivel mundial. El cáncer de pulmón es el tipo de cáncer más común en hombres y mujeres. Clasificar muestras de pacientes con cáncer de pulmón utilizando datos de la expresión de los genes puede ayudar a mejorar el proceso de diagnóstico y tratamiento de esta enfermedad. Los 9 genes analizados en este estudio fueron seleccionados en un proyecto previo por su capacidad para diferenciar tipos de cáncer de pulmón en pacientes utilizado algoritmos de Machine Learning. El objetivo del presente estudio es determinar cuáles genes tienen mayor impacto en la mortalidad de los pacientes de este tipo de cáncer mediante un análisis de supervivencia utilizado el modelo estadístico de Kaplan-Meier.

### Integrantes:

- Morales Luna Emilio

### Objetivos:

```{r}
library('dplyr')
library(ggplot2)
library(readxl)
library(survival)
library(tidyverse)
# install.packages("gtsummary")
library(gtsummary)
```

##### Especificar la ruta del archivo Excel

Ruta de Emilio:

```{r}
#setwd("C:/Users/1097513297/Documents/BEDU/R_works/Proyecto_Cancer")
#getwd()
#archivo_excel <- "C:/Users/1097513297/Documents/BEDU/R_works/Proyecto_Cancer/Genes para superviencia.xlsx"
```

Ruta Misael:

```{r}
#setwd("/Users/misaeljara/Downloads/Genes para superviencia.xlsx")
#getwd()
archivo_excel <- "/Users/misaeljara/Downloads/Genes para superviencia.xlsx"

```

### Declaramos la lista de dataframes

```{r}
lista_dataframes <- lapply(excel_sheets(archivo_excel), function(sheet) {
  read_excel(archivo_excel, sheet = sheet)
})

```

### Nombramos cada índice de la lista

```{r}
lista_genes <- lista_dataframes [[1]]
CDHR1 <- lista_dataframes [[2]]
DSC3 <- lista_dataframes [[3]]
GJB5 <- lista_dataframes [[4]]
S1PR5 <- lista_dataframes [[5]]
GPC1 <- lista_dataframes [[6]]
GJB6 <- lista_dataframes [[7]]
DSG3 <- lista_dataframes [[8]]
SLC2A1 <- lista_dataframes [[9]]
FAT2 <- lista_dataframes [[10]]

```

#### Usamos el paquete de supervivencia

[Introducción a la paqueteria]

## Gen CDHR1

Codifica para la proteína cadherina-1, relacionada con la adhesión celular y la diferenciación tisular.

### Realizamos dos listas filtradas
```{r}
#Filtro expresion alta
exp_alta <- CDHR1[CDHR1$`Expression (1=high)` < 1 , ]

#Filtro expresion baja
exp_baja <- CDHR1[CDHR1$`Expression (1=high)` > 0 , ]
```

Creamos los objetos de supervivencia
```{r}
datos_supervivencia_alta <- Surv(exp_alta$`Time (months)`, exp_alta$Event)
datos_supervivencia_baja <- Surv(exp_baja$`Time (months)`, exp_baja$Event)

modelo_km_alta <- survfit(datos_supervivencia_alta ~ 1)
modelo_km_baja <- survfit(datos_supervivencia_baja ~ 1)
```

#### Obtenemos gráficas del supervivencia de expresión alta y baja

Hazard ratio (HR): El cociente de riesgo o Hazard ratio, es el riesgo relativo de que ocurra un evento (por ejemplo, progresión de la enfermedad) en un grupo del ensayo en comparación al otro, durante toda la duración del estudio.

Un HR de 1 significa que no hay diferencia entre los grupos, un HR de 2 significa que hay un riesgo doble y un HR de 0,5 indica que hay la mitad de riesgo de que un evento ocurra en un grupo con respecto al otro.

```{r}

plot(modelo_km_alta, main = "Curva de Kaplan-Meier", xlab = "Tiempo (meses)", ylab = "Probabilidad de supervivencia", col = 2, lwd = 2)
lines(modelo_km_baja,lwd=2,col="blue")
legend('bottomright',inset=0.05,c("Expresión Alta","Expresión Baja"),lty=1,col=c("red","blue"),title="Gráficas")

coxph( Surv(CDHR1$`Time (months)`, CDHR1$Event) ~ CDHR1$`Expression (1=high)`, data = CDHR1) %>% 
  tbl_regression(exp = TRUE) 
```

De acuerdo a la grafica de Kaplan-Meier del gen CDHR1, se observa la probabilidad de supervivencia es menor  cuando el gen se encuentra en un nivel bajo. Ademas, el P-value es menor al 0.05 (0.001) por lo que se rechaza la hipotesis nula y se confirma que hay una diferencia estadisticamente significativa entre los dos niveles de expresion del gen. Finalmente, el Hazard Ratio tiene un valor de 1.33, indicando que cuando el gen se encuentra expresado en el nivel bajo existe una probabilidad de muerte 33% mayor que cuando esta en el nivel alto. 


```{r}
#Filtrar muertes en el dataset
dataset_muertes <- CDHR1[CDHR1$Event == 1 , ]

histograma <- hist(dataset_muertes$`Time (months)`, breaks = 60, main = "Histograma de muertes", xlab = "Tiempo (meses)", ylab = "Frecuencia muertes", col = "lightblue", border = "black")

# Acceder a los intervalos y frecuencias del histograma
tiempo <- histograma$breaks[-1]
frecuencia <- histograma$counts
```

### Gráficas

```{r}
# Mostrar los intervalos y frecuencias
tabla_frec <- data.frame(tiempo,frecuencia)

# Graficar la serie de tiempo con ggplot2
ggplot(tabla_frec, aes(x = tiempo, y = frecuencia)) +
  geom_line() +
  labs(title = "Serie de Tiempo de Muertes", x = "Tiempo (meses)", y = "Número de muertes")

```




## Gen DSC3

### Realizamos listas filtradas para el siguiente gen DSC3
```{r}
#Filtro expresion alta
exp_alta_dsc3<- DSC3[DSC3$`Expression (1=high)` < 1 , ]

#Filtro expresion baja
exp_baja_dsc3 <- DSC3[DSC3$`Expression (1=high)` > 0 , ]
```

## Objetos de Supervivencia para nuestro gen DSC3    
```{r}

datos_supervivencia_alta_dsc3 <- Surv(exp_alta_dsc3$`Time (months)`, exp_alta_dsc3$Event)
datos_supervivencia_baja_dsc3 <- Surv(exp_baja_dsc3$`Time (months)`, exp_baja_dsc3$Event)

modelo_km_alta_dsc3 <- survfit(datos_supervivencia_alta_dsc3 ~ 1)
modelo_km_baja_dsc3 <- survfit(datos_supervivencia_baja_dsc3 ~ 1)

```


#### Obtenemos gráficas del supervivencia de expresión alta y baja en Gen DSC3
```{r}
plot(modelo_km_alta_dsc3, main = "Curva de Kaplan-Meier DSC3", xlab = "Tiempo (meses)", ylab = "Probabilidad de supervivencia", col = 2, lwd = 2)
lines(modelo_km_baja_dsc3,lwd=2,col="blue")
legend('bottomright',inset=0.05,c("Expresión Alta","Expresión Baja"),lty=1,col=c("red","blue"),title="Gráficas")

coxph( Surv(DSC3$`Time (months)`, DSC3$Event) ~ DSC3$`Expression (1=high)`, data = DSC3) %>% 
  tbl_regression(exp = TRUE) 


```


#### Filtrando muertes para el gen DSC3
```{r}
#Filtrar muertes en el dataset
dataset_muertes_dsc3 <- DSC3[DSC3$Event == 1 , ]

histograma_dsc3  <- hist(dataset_muertes_dsc3$`Time (months)`, breaks = 60, main = "Histograma de muertes DSC3", xlab = "Tiempo (meses)", ylab = "Frecuencia muertes", col = "yellow", border = "black")

# Acceder a los intervalos y frecuencias del histograma
tiempo_dsc3 <- histograma_dsc3 $breaks[-1]
frecuencia_dsc3 <- histograma_dsc3 $counts

```

```{r}
# Mostrar los intervalos y frecuencias
tabla_frec_dsc3  <- data.frame(tiempo_dsc3 ,frecuencia_dsc3 )

# Graficar la serie de tiempo con ggplot2
ggplot(tabla_frec_dsc3 , aes(x = tiempo_dsc3 , y = frecuencia_dsc3 )) +
  geom_line() +
  labs(title = "Serie de Tiempo de Muertes", x = "Tiempo (meses)", y = "Número de muertes")

```
#### En el siguiente Gen que trabajaremos es el GJB5 

#### Filtracion para GJB5
```{r}
#Filtro expresion alta
exp_alta_gjb5 <- GJB5[GJB5$`Expression (1=high)` < 1 , ]

#Filtro expresion baja
exp_baja_gjb5 <- GJB5[GJB5$`Expression (1=high)` > 0 , ]
```
#### Creacion de supervivencia GBJ5
```{r}
datos_supervivencia_alta_gjb5 <- Surv(exp_alta_gjb5$`Time (months)`, exp_alta_gjb5$Event)
datos_supervivencia_baja_gjb5 <- Surv(exp_baja_gjb5$`Time (months)`, exp_baja_gjb5$Event)

modelo_km_alta_gjb5 <- survfit(datos_supervivencia_alta_gjb5 ~ 1)
modelo_km_baja_gjb5 <- survfit(datos_supervivencia_baja_gjb5 ~ 1)
```
#### Graficas de supervivencia 
```{r}
plot(modelo_km_alta_gjb5, main = "Curva de Kaplan-Meier GJB5", xlab = "Tiempo (meses)", ylab = "Probabilidad de supervivencia", col = 2, lwd = 2)
lines(modelo_km_baja_gjb5,lwd=2,col="blue")
legend('bottomright',inset=0.05,c("Expresión Alta","Expresión Baja"),lty=1,col=c("red","blue"),title="Gráficas GJB5")

coxph( Surv(GJB5$`Time (months)`, GJB5$Event) ~ GJB5$`Expression (1=high)`, data = GJB5) %>% 
  tbl_regression(exp = TRUE) 

```


```{r}
#Filtrar muertes en el dataset
dataset_muertes_gjb5 <- GJB5[GJB5$Event == 1 , ]

histograma_gjb5  <- hist(dataset_muertes_gjb5 $`Time (months)`, breaks = 60, main = "Histograma de muertes GJB5", xlab = "Tiempo (meses)", ylab = "Frecuencia muertes", col = "lightblue", border = "black")

# Acceder a los intervalos y frecuencias del histograma
tiempo_gjb5  <- histograma_gjb5 $breaks[-1]
frecuencia_gjb5  <- histograma_gjb5 $counts

```


```{r}
# Mostrar los intervalos y frecuencias
tabla_frec_gjb5 <- data.frame(tiempo_gjb5,frecuencia_gjb5)

# Graficar la serie de tiempo con ggplot2
ggplot(tabla_frec_gjb5, aes(x = tiempo_gjb5, y = frecuencia_gjb5)) +
  geom_line() +
  labs(title = "Serie de Tiempo de Muertes", x = "Tiempo (meses)", y = "Número de muertes")

```


#### Ahora empezaremos con el gen S1PR5
Filtro para sacar expresiones S1PR5

```{r}
#Filtro expresion alta
exp_alta_s1pr5 <- S1PR5[S1PR5$`Expression (1=high)` < 1 , ]

#Filtro expresion baja
exp_baja_s1pr5  <- S1PR5[S1PR5$`Expression (1=high)` > 0 , ]

```
## objetos de supervivencia 
```{r}
datos_supervivencia_alta_s1pr5 <- Surv(exp_alta_s1pr5$`Time (months)`, exp_alta_s1pr5$Event)
datos_supervivencia_baja_s1pr5 <- Surv(exp_baja_s1pr5$`Time (months)`, exp_baja_s1pr5$Event)

modelo_km_alta_s1pr5 <- survfit(datos_supervivencia_alta_s1pr5 ~ 1)
modelo_km_baja_s1pr5 <- survfit(datos_supervivencia_baja_s1pr5 ~ 1)

```
## Modelado para sacar Hazard Ratio S1PR5
```{r}
plot(modelo_km_alta_s1pr5, main = "Curva de Kaplan-Meier S1PR5", xlab = "Tiempo (meses)", ylab = "Probabilidad de supervivencia", col = 2, lwd = 2)
lines(modelo_km_baja_s1pr5,lwd=2,col="blue")
legend('bottomright',inset=0.05,c("Expresión Alta","Expresión Baja"),lty=1,col=c("red","blue"),title="Gráficas")

coxph( Surv(S1PR5$`Time (months)`, S1PR5$Event) ~ S1PR5$`Expression (1=high)`, data = S1PR5) %>% 
  tbl_regression(exp = TRUE)

```

```{r}
#Filtrar muertes en el dataset
dataset_muertes_s1pr5 <- S1PR5[S1PR5$Event == 1 , ]

histograma_s1pr5 <- hist(dataset_muertes_s1pr5$`Time (months)`, breaks = 60, main = "Histograma de muertes S1PR5", xlab = "Tiempo (meses)", ylab = "Frecuencia muertes", col = "lightblue", border = "black")

# Acceder a los intervalos y frecuencias del histograma
tiempo_s1pr5 <- histograma_s1pr5$breaks[-1]
frecuencia_s1pr5 <- histograma_s1pr5$counts
```


```{r}
# Mostrar los intervalos y frecuencias
tabla_frec_s1pr5 <- data.frame(tiempo_s1pr5,frecuencia_s1pr5)

# Graficar la serie de tiempo con ggplot2
ggplot(tabla_frec_s1pr5, aes(x = tiempo_s1pr5, y = frecuencia_s1pr5)) +
  geom_line() +
  labs(title = "Serie de Tiempo de Muertes", x = "Tiempo (meses)", y = "Número de muertes")

```


Ultimo GPC1
Filtros de Expresiones GPC1
```{r}
#Filtro expresion alta
exp_alta_gpc1 <- GPC1[GPC1$`Expression (1=high)` < 1 , ]

#Filtro expresion baja
exp_baja_gpc1 <- GPC1[GPC1$`Expression (1=high)` > 0 , ]

```
Objetos de Supervivencia GPC1
```{r}
datos_supervivencia_alta_gpc1 <- Surv(exp_alta_gpc1$`Time (months)`, exp_alta_gpc1$Event)
datos_supervivencia_baja_gpc1 <- Surv(exp_baja_gpc1$`Time (months)`, exp_baja_gpc1$Event)

modelo_km_alta_gpc1 <- survfit(datos_supervivencia_alta_gpc1 ~ 1)
modelo_km_baja_gpc1 <- survfit(datos_supervivencia_baja_gpc1 ~ 1)
```
Graficas de supervivencia GPC1
```{r}
plot(modelo_km_alta_gpc1, main = "Curva de Kaplan-Meier GPC1", xlab = "Tiempo (meses)", ylab = "Probabilidad de supervivencia", col = 2, lwd = 2)
lines(modelo_km_baja_gpc1,lwd=2,col="blue")
legend('bottomright',inset=0.05,c("Expresión Alta","Expresión Baja"),lty=1,col=c("red","blue"),title="Gráficas")

coxph( Surv(GPC1$`Time (months)`, GPC1$Event) ~ GPC1$`Expression (1=high)`, data = GPC1) %>% 
  tbl_regression(exp = TRUE)
```
#### Filtracion de Muertes GPC1
```{r}
#Filtrar muertes en el dataset
dataset_muertes_gpc1 <- GPC1[GPC1$Event == 1 , ]

histograma_gpc1 <- hist(dataset_muertes_gpc1$`Time (months)`, breaks = 60, main = "Histograma de muertes", xlab = "Tiempo (meses)", ylab = "Frecuencia muertes", col = "lightblue", border = "black")

# Acceder a los intervalos y frecuencias del histograma
tiempo_gpc1 <- histograma_gpc1$breaks[-1]
frecuencia_gpc1 <- histograma_gpc1$counts
```

#### Intervalos y Frequencias
```{r}
tabla_frec_gpc1 <- data.frame(tiempo_gpc1,frecuencia_gpc1)

# Graficar la serie de tiempo con ggplot2
ggplot(tabla_frec_gpc1, aes(x = tiempo_gpc1, y = frecuencia_gpc1)) +
  geom_line() +
  labs(title = "Serie de Tiempo de Muertes", x = "Tiempo (meses)", y = "Número de muertes")
```

```{r}
```

```{r}
```

```{r}
```

```{r}
```





















